deploy:
    needs: build-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: redhat-actions/oc-login@v1
        with: # ... credenciales ...

      # --- REGLA 1: Si es un push a la rama 'develop', va a DEV ---
      - name: Deploy to Dev
        if: github.ref == 'refs/heads/develop'
        run: |
          helm upgrade --install bootcamp-dev ./mi-chart \name: DevOps Master - Multi-Environment Pipeline

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*" ] # Se dispara con v1.0, v2.1.0, etc.
  pull_request:
    branches: [ "main" ]

jobs:
  # --- FASE 1: CI & BUILD (Se ejecuta siempre para validar el cambio) ---
  ci-and-build:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Tests & Coverage
        run: |
          pip install -r requirements.txt
          pytest --cov=app --cov-report=xml test_app.py

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Log in to GitHub Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Generamos etiquetas inteligentes para la imagen Docker
      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/taylinn
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}

  # --- FASE 2: DESPLIEGUE EN DESARROLLO (Rama: develop) ---
  deploy-dev:
    needs: ci-and-build
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: development # Vincula este job al entorno 'development' de GitHub
    steps:
      - uses: actions/checkout@v4
      - name: Install oc
        uses: redhat-actions/openshift-tools-installer@v1
        with: { oc: "4" }

      - name: Log in to OpenShift Dev
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: taylinn-dev

      - name: Helm Deploy Dev
        run: |
          helm upgrade --install bootcamp-dev ./mi-chart \
            -f ./mi-chart/values-dev.yaml

  # --- FASE 3: DESPLIEGUE EN PRE-PRODUCCIÓN (Rama: main) ---
  deploy-pre:
    needs: ci-and-build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Install oc
        uses: redhat-actions/openshift-tools-installer@v1
        with: { oc: "4" }

      - name: Log in to OpenShift Pre
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: taylinn-pre

      - name: Helm Deploy Pre
        run: |
          helm upgrade --install bootcamp-pre ./mi-chart \
            -f ./mi-chart/values-pre.yaml

  # --- FASE 4: DESPLIEGUE EN PRODUCCIÓN (Tags: v*) ---
  deploy-pro:
    needs: ci-and-build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    environment: production # Aquí activaremos la "Aprobación Manual"
    steps:
      - uses: actions/checkout@v4
      - name: Install oc
        uses: redhat-actions/openshift-tools-installer@v1
        with: { oc: "4" }

      - name: Log in to OpenShift Pro
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_PRO || secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN_PRO || secrets.OPENSHIFT_TOKEN }}
          namespace: taylinn-pro

      - name: Helm Deploy Pro
        run: |
          # En Pro usamos la versión del tag específica para mayor seguridad
          VERSION=${GITHUB_REF#refs/tags/}
          helm upgrade --install bootcamp-pro ./mi-chart \
            -f ./mi-chart/values-pro.yaml \
            --set image.tag=$VERSION
            -f ./mi-chart/values-dev.yaml \
            --namespace taylinn-dev

      # --- REGLA 2: Si es un push a la rama 'main', va a PRE ---
      - name: Deploy to Pre
        if: github.ref == 'refs/heads/main'
        run: |
          helm upgrade --install bootcamp-pre ./mi-chart \
            -f ./mi-chart/values-pre.yaml \
            --namespace taylinn-pre

      # --- REGLA 3: Si creamos un TAG (v1.x), va a PRO ---
      - name: Deploy to Pro
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          helm upgrade --install bootcamp-pro ./mi-chart \
            -f ./mi-chart/values-pro.yaml \
            --namespace taylinn-pro