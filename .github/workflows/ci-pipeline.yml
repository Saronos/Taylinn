name: DevOps Bootcamp Pipeline

# Trigger: ¿Cuándo se ejecuta esto?
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # TRABAJO 1: INTEGRACIÓN CONTINUA (CI)
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Bajar código del repo
      uses: actions/checkout@v4

    - name: Instalar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Ejecutar Tests y Análisis
      run: |
        # Aquí es donde ella verá fallar el pipeline si rompe el código
        pytest --cov=app test_app.py

  # TRABAJO 2: CONSTRUIR IMAGEN (Solo si los tests pasan)
  docker-build:
    needs: build-and-test # Dependencia: si falla el test, esto no corre
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Solo corre en main (por ahora)
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # OJO: Taylinn tendrá que cambiar 'usuario' por su usuario de GitHub
          tags: ghcr.io/${{ github.repository_owner }}/bootcamp-app:latest
